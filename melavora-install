#!/bin/bash

# Preconfigure MySQL
apt-get update

# Generate admin password

mysqlPassword=`head -c 64 /dev/urandom | sha1sum | awk "{print substr(\\$1, 0, 16)}"`
appPassword=`head -c 64 /dev/urandom | sha1sum | awk "{print substr(\\$1, 0, 16)}"`

printf "\e[1;31mMySQL root Password:\e[0m\e[31m ${mysqlPassword}\e[0m\n"
printf "\e[1;31mMySQL mellivora Password:\e[0m\e[31m ${appPassword}\e[0m\n"

sudo debconf-set-selections <<< "mysql-server mysql-server/root_password password ${mysqlPassword}"
sudo debconf-set-selections <<< "mysql-server mysql-server/root_password_again password ${mysqlPassword}"
apt-get install -y mysql-server mysql-client mysql-utilities\
    apache2 git php5 php5-curl php-pear php5-mysql sendmail-bin sendmail

curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

sudo chown -R ctf:ctf /var/www/
cd /var/www/

git clone https://github.com/Nakiami/mellivora.git

cd /var/www/mellivora/
composer install

echo "\
PD9waHAKCi8vICogRGF0YWJhc2UgdGltZSBhbmQgUEhQIHRpbWUgc2hvdWxkIGFsd2F5cyBiZSB0\
aGUgc2FtZS4KLy8gKiBTZWU6IGh0dHA6Ly93d3cucGhwLm5ldC9tYW51YWwvZW4vdGltZXpvbmVz\
LnBocCBmb3Igem9uZXMKLy8gKiBJZiB0aW1lIHpvbmVzIGRpZmZlciwgeW91IGNhbiB1c2UgdGhl\
IHNldHRpbmdzIGJlbG93IHRvIHJlY3RpZnkKLy8gICB0aGUgcHJvYmxlbSwgYnV0IHRoaXMgaXMg\
YW4gZXhwZW5zaXZlIG9wZXJhdGlvbiwgYXMgdGhlIHNldHRpbmcKLy8gICBpcyBjaGFuZ2VkIGVh\
Y2ggdGltZSB0aGUgcGFnZSBsb2Fkcy4gWW91IHNob3VsZCBwcm9iYWJseSB1c2UgdGhlCi8vICAg\
c2V0dGluZyAiZGF0ZS50aW1lem9uZSIgaW4gcGhwLmluaS4KLy9jb25zdCBDT05GSUdfREFURV9E\
RUZBVUxUX1RJTUVaT05FID0gJ0F1c3RyYWxpYS9TeWRuZXknOwovL2RhdGVfZGVmYXVsdF90aW1l\
em9uZV9zZXQoQ09ORklHX0RBVEVfREVGQVVMVF9USU1FWk9ORSk7CgovLyBwYXRocyBiZWxvdyBt\
dXN0IGVuZCBpbiBhICIvIiAhCmNvbnN0IENPTkZJR19QQVRIX0JBU0UgPSAnL3Zhci93d3cvbWVs\
bGl2b3JhLyc7CgovLyBkYXRhYmFzZSBzZXR0aW5ncwpyZXF1aXJlKCdkYi5pbmMucGhwJyk7Cgov\
LyBsYW5ndWFnZQpjb25zdCBDT05GSUdfU0lURV9MQU5HVUFHRSA9ICdlbic7CgovLyBnZW5lcmFs\
IHNpdGUgc2V0dGluZ3MKY29uc3QgQ09ORklHX1NJVEVfTkFNRSA9ICdLMTcgQ1RGJzsKY29uc3Qg\
Q09ORklHX1NJVEVfU0xPR0FOID0gJ0hhY2sgdGhlIFBsYW5ldCc7CmNvbnN0IENPTkZJR19TSVRF\
X0RFU0NSSVBUSU9OID0gJyc7CmNvbnN0IENPTkZJR19TSVRFX1VSTCA9ICdodHRwOi8vc2NvcmVz\
LmhhY2tpbmdpbi5zcGFjZS8nOwpjb25zdCBDT05GSUdfU0lURV9VUkxfU1RBVElDX1JFU09VUkNF\
UyA9ICdodHRwOi8vc2NvcmVzLmhhY2tpbmdpbi5zcGFjZS8nOwpjb25zdCBDT05GSUdfU0lURV9B\
RE1JTl9SRUxQQVRIID0gJ2FkbWluLyc7CmRlZmluZSgnQ09ORklHX1NJVEVfQURNSU5fVVJMJywg\
Q09ORklHX1NJVEVfVVJMIC4gQ09ORklHX1NJVEVfQURNSU5fUkVMUEFUSCk7CgovLyByZWRpcmVj\
dHM6CmNvbnN0IENPTkZJR19JTkRFWF9SRURJUkVDVF9UTyA9ICdob21lJzsgLy8gZnJvbSBpbmRl\
eC5waHAKY29uc3QgQ09ORklHX0xPR0lOX1JFRElSRUNUX1RPID0gJ2hvbWUnOyAvLyBhZnRlciBs\
b2dpbgpjb25zdCBDT05GSUdfUkVHSVNURVJfUkVESVJFQ1RfVE8gPSAnaG9tZSc7IC8vIGFmdGVy\
IHN1Y2Nlc3NmdWwgYWNjb3VudCByZWdpc3RyYXRpb24KCi8vIHRlYW0gbmFtZXMgbG9uZ2VyIHRo\
YW4gMzAgY2hhcnMgbWF5IGJyZWFrIHBhZ2UgbGF5b3V0CmNvbnN0IENPTkZJR19NSU5fVEVBTV9O\
QU1FX0xFTkdUSCA9IDI7CmNvbnN0IENPTkZJR19NQVhfVEVBTV9OQU1FX0xFTkdUSCA9IDMwOwpj\
b25zdCBDT05GSUdfQUNDT1VOVFNfU0lHTlVQX0FMTE9XRUQgPSB0cnVlOwpjb25zdCBDT05GSUdf\
QUNDT1VOVFNfREVGQVVMVF9FTkFCTEVEID0gdHJ1ZTsKCi8vIGlmIHNldCB0byB0cnVlLCBhIHJh\
bmRvbSBwYXNzd29yZCB3aWxsIGJlIGdlbmVyYXRlZAovLyBvbiBzaWdudXAgYW5kIHNlbnQgb3V0\
IGJ5IGVtYWlsIHRvIHRoZSB1c2VyCmNvbnN0IENPTkZJR19BQ0NPVU5UU19FTUFJTF9QQVNTV09S\
RF9PTl9TSUdOVVAgPSBmYWxzZTsKCi8vIGlzIHNpdGUgU1NMIGNvbXBhdGlibGU/IGlmIHRydWUs\
IHNzbCB3aWxsIGJlIGZvcmNlZCBvbiBjZXJ0YWluIHBhZ2VzCmNvbnN0IENPTkZJR19TU0xfQ09N\
UEFUID0gZmFsc2U7CgovLyBzZXNzaW9uICYgY29va2llIGV4cGlyeSB0aW1lIGluIHNlY29uZHMK\
Ly8gMCA9IHVudGlsIGJyb3dzZXIgaXMgY2xvc2VkCmNvbnN0IENPTkZJR19TRVNTSU9OX1RJTUVP\
VVQgPSAwOwpjb25zdCBDT05GSUdfQ09PS0lFX1RJTUVPVVQgPSA2MDQ4MDA7CgovLyBsb2dnaW5n\
IG9wdGlvbnMKY29uc3QgQ09ORklHX0xPR19WQUxJREFUSU9OX0ZBSUxVUkVfSUQgPSB0cnVlOwoK\
Ly8gbWF4aW11bSBmaWxlIHVwbG9hZCBzaXplCmNvbnN0IENPTkZJR19NQVhfRklMRV9VUExPQURf\
U0laRSA9IDUyNDI4ODA7CmNvbnN0IENPTkZJR19BUFBFTkRfTUQ1X1RPX0RPV05MT0FEUyA9IGZh\
bHNlOwoKLy8gZW1haWwgc3R1ZmYKY29uc3QgQ09ORklHX0VNQUlMX1VTRV9TTVRQID0gZmFsc2U7\
CmNvbnN0IENPTkZJR19FTUFJTF9GUk9NX0VNQUlMID0gJ2N0ZkBoYWNraW5naW4uc3BhY2UnOwpj\
b25zdCBDT05GSUdfRU1BSUxfRlJPTV9OQU1FID0gJ0sxN0NURic7Ci8vIGJsYW5rIGZvciBzYW1l\
IGFzICJGUk9NIgpjb25zdCBDT05GSUdfRU1BSUxfUkVQTFlUT19FTUFJTCA9ICcnOwpjb25zdCBD\
T05GSUdfRU1BSUxfUkVQTFlUT19OQU1FID0gJyc7Ci8vIG9wdGlvbnM6Ci8vIDAgPSBvZmYgKGZv\
ciBwcm9kdWN0aW9uIHVzZSkKLy8gMSA9IGNsaWVudCBtZXNzYWdlcwovLyAyID0gY2xpZW50IGFu\
ZCBzZXJ2ZXIgbWVzc2FnZXMKY29uc3QgQ09ORklHX0VNQUlMX1NNVFBfREVCVUdfTEVWRUwgPSAy\
Owpjb25zdCBDT05GSUdfRU1BSUxfU01UUF9IT1NUID0gJ3NtdHAuZ21haWwuY29tJzsKY29uc3Qg\
Q09ORklHX0VNQUlMX1NNVFBfUE9SVCA9IDU4NzsKY29uc3QgQ09ORklHX0VNQUlMX1NNVFBfU0VD\
VVJJVFkgPSAndGxzJzsKLy8gcmVxdWlyZSBTTVRQIGF1dGhlbnRpY2F0aW9uPwpjb25zdCBDT05G\
SUdfRU1BSUxfU01UUF9BVVRIID0gdHJ1ZTsKY29uc3QgQ09ORklHX0VNQUlMX1NNVFBfVVNFUiA9\
ICdjdXJ0aXMubWlsbGFyQGdtYWlsLmNvbSc7CmNvbnN0IENPTkZJR19FTUFJTF9TTVRQX1BBU1NX\
T1JEID0gJ3ltaGJrdnZ3dHhqbHhjdGsnOwoKLy8gZW5hYmxlIHJlLWNhcHRjaGEgb24gc2lnbnVw\
IGFuZCB2YXJpb3VzIHB1YmxpYyBmb3Jtcwpjb25zdCBDT05GSUdfUkVDQVBUQ0hBX0VOQUJMRV9Q\
VUJMSUMgPSBmYWxzZTsKLy8gZW5hYmxlZCBjYXB0Y2hhIGFsc28gb24gcHJpdmF0ZSBmb3JtcyBm\
b3IgbG9nZ2VkIGluIHVzZXJzCmNvbnN0IENPTkZJR19SRUNBUFRDSEFfRU5BQkxFX1BSSVZBVEUg\
PSBmYWxzZTsKLy8gcmUtY2FwdGNoYSBrZXlzIG11c3QgYmUgc2V0IHRvIGZ1bmN0aW9uCmNvbnN0\
IENPTkZJR19SRUNBUFRDSEFfUFVCTElDX0tFWSA9ICcnOwpjb25zdCBDT05GSUdfUkVDQVBUQ0hB\
X1BSSVZBVEVfS0VZID0gJyc7CgovLyBvbmx5IHRydXN0IHgtZm9yd2FyZGVkLWZvciBpcCBhZGRy\
ZXNzIGlmIHlvdSdyZSBydW5uaW5nCi8vIHNvbWUgc29ydCBvZiByZXZlcnNlIHByb3h5LCBsaWtl\
IENsb3VkZmxhcmUuIHdoZW4gc2V0Ci8vIHRvIHRydWUsIHRoZSBsYXRlc3QgYWRkZWQgZm9yd2Fy\
ZGVkLWZvciBpcCB3aWxsIGJlIHVzZWQKLy8gZm9yIGxvZ2dpbmcgYW5kIGhvdXNla2VlcGluZwpj\
b25zdCBDT05GSUdfVFJVU1RfSFRUUF9YX0ZPUldBUkRFRF9GT1JfSVAgPSBmYWxzZTsKCi8vIHdo\
ZW4gdGhpcyBpcyBzZXQgdG8gdHJ1ZSwgYW4gSVAgYWRkcmVzcwovLyB3aWxsIGJlIHJlc29sdmVk\
IHdoZW4gaXQgaXMgbGlzdGVkLiBzZXQKLy8gdGhpcyB0byBmYWxzZSBpZiBETlMgcmVzb2x1dGlv\
biBpcyB0b28KLy8gc2xvdyB3aGVuIGxpc3RpbmcgYSB1c2VycyBJUHMKY29uc3QgQ09ORklHX0dF\
VF9JUF9IT1NUX0JZX0FERFJFU1MgPSB0cnVlOwoKLy8gY2FjaGUgdGltZXMKY29uc3QgQ09ORklH\
X0NBQ0hFX1RJTUVfU0NPUkVTID0gMDsKY29uc3QgQ09ORklHX0NBQ0hFX1RJTUVfSE9NRSA9IDA7\
CmNvbnN0IENPTkZJR19DQUNIRV9USU1FX1VTRVIgPSAwOwpjb25zdCBDT05GSUdfQ0FDSEVfVElN\
RV9DSEFMTEVOR0UgPSAwOwpjb25zdCBDT05GSUdfQ0FDSEVfVElNRV9ISU5UUyA9IDA7CmNvbnN0\
IENPTkZJR19DQUNIRV9USU1FX0ZJTEVTID0gMDsKY29uc3QgQ09ORklHX0NBQ0hFX1RJTUVfQ09V\
TlRSSUVTID0gMDsKY29uc3QgQ09ORklHX0NBQ0hFX1RJTUVfRFlOQU1JQyA9IDA7CmNvbnN0IENP\
TkZJR19DQUNIRV9USU1FX1JFR0lTVEVSID0gMDsKCi8vIHVzZXIgdHJhY2tpbmcgYW5kIHN0YXRp\
c3RpY3MKY29uc3QgQ09ORklHX1NFR01FTlRfSU9fS0VZID0gJyc7CgovLyBBbWF6b24gUzMgY3Jl\
ZGVudGlhbHMsIGZvciBzdG9yaW5nIGZpbGVzIGluIFMzLgovLyBMZWF2ZSBibGFuayB0byBzdG9y\
ZSBmaWxlcyBsb2NhbGx5Lgpjb25zdCBDT05GSUdfQVdTX1MzX0tFWV9JRCA9ICcnOwpjb25zdCBD\
T05GSUdfQVdTX1MzX1NFQ1JFVCA9ICcnOwpjb25zdCBDT05GSUdfQVdTX1MzX0JVQ0tFVCA9ICcn\
Owo="\
    | base64 -d > /var/www/mellivora/include/config/config.inc.php
echo "\
PD9waHAKCmNvbnN0IERCX0VOR0lORSA9ICdteXNxbCc7CmNvbnN0IERCX0hPU1QgPSAnbG9jYWxo\
b3N0JzsKY29uc3QgREJfUE9SVCA9IDMzMDY7CmNvbnN0IERCX05BTUUgPSAnbWVsbGl2b3JhJzsK\
Y29uc3QgREJfVVNFUiA9ICdtZWxsaXZvcmEnOwpjb25zdCBEQl9QQVNTV09SRCA9ICd7e01FTExJ\
Vk9SQV9QQVNTV09SRH19JzsK" | base64 -d\
    | sed "s/{{MELLIVORA_PASSWORD}}/${appPassword}/"\
    > /var/www/mellivora/include/config/db.inc.php

sudo chown -R www-data:www-data /var/www/mellivora/writable/

echo "\
PFZpcnR1YWxIb3N0ICo6ODA+CgogICBTZXJ2ZXJBZG1pbiBjdGZAaGFja2luZ2luLnNwYWNlCiAg\
IERvY3VtZW50Um9vdCAvdmFyL3d3dy9tZWxsaXZvcmEvaHRkb2NzLwoKICAgPERpcmVjdG9yeSAv\
PgogICAgICBPcmRlciBEZW55LEFsbG93CiAgICAgIERlbnkgZnJvbSBhbGwKICAgICAgQWxsb3dP\
dmVycmlkZSBOb25lCiAgIDwvRGlyZWN0b3J5PgoKICAgPERpcmVjdG9yeSAiL3Zhci93d3cvbWVs\
bGl2b3JhL2h0ZG9jcy8iPgogICAgICBPcHRpb25zIC1JbmRleGVzICtNdWx0aVZpZXdzCiAgICAg\
IEFsbG93T3ZlcnJpZGUgTm9uZQogICAgICBPcmRlciBEZW55LEFsbG93CiAgICAgIEFsbG93IGZy\
b20gYWxsCiAgICAgIEFkZFR5cGUgYXBwbGljYXRpb24veC1odHRwZC1waHAgLnBocAogICA8L0Rp\
cmVjdG9yeT4KCiAgICMgZXJyb3IgbG9nCiAgIEVycm9yTG9nIC92YXIvbG9nL2FwYWNoZTIvbWVs\
bGl2b3JhLWVycm9yLmxvZwogICBMb2dMZXZlbCB3YXJuCgogICAjIGFjY2VzcyBsb2cKICAgQ3Vz\
dG9tTG9nIC92YXIvbG9nL2FwYWNoZTIvbWVsbGl2b3JhLWFjY2Vzcy5sb2cgY29tYmluZWQKCjwv\
VmlydHVhbEhvc3Q+Cg=="\
    | base64 -d > /etc/apache2/sites-available/mellivora.conf

sudo a2dissite 000-default
sudo a2ensite mellivora
sudo service apache2 restart

echo "CREATE DATABASE mellivora CHARACTER SET utf8 COLLATE utf8_general_ci;" | mysql -u root -p"${mysqlPassword}"
mysql mellivora -u root -p"${mysqlPassword}" < /var/www/mellivora/install/mellivora.sql
mysql mellivora -u root -p"${mysqlPassword}" < /var/www/mellivora/install/countries.sql

echo "GRANT ALL PRIVILEGES ON mellivora.* TO 'mellivora'@'%' IDENTIFIED BY '${appPassword}';" | mysql -u root -p"${mysqlPassword}"

echo "Now visit http://`hostname`/ and create a new user."
echo "Press enter to continue and make first user admin."
read
echo "UPDATE users SET class = 100 WHERE id = 1;" | mysql mellivora -u root -p"${mysqlPassword}"

